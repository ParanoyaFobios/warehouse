<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="nav-link" href="{% url 'start-page' %}">–ì–ª–∞–≤–Ω–∞—è</a>
                <div class="container-fluid">
                    <form class="d-flex align-items-center" action="{% url 'global_search' %}" method="get" id="filter-form">
                        {{ global_search_form.q }}
                        <button class="btn btn-outline-secondary ms-2" type="button" 
                                title="–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥" id="global-scan-btn" style="min-width: 50px;">
                            üì∏
                        </button>
                        <button class="btn btn-success ms-2" type="submit">–ü–æ–∏—Å–∫</button>
                    </form>
                    <video id="video-stream" style="display: none; width: 100%; max-width: 400px; margin-bottom: 1rem;"></video>
                </div>
                <div class="navbar-nav">
                    <a class="nav-link" href="{% url 'material_list' %}">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</a>
                    <a class="nav-link" href="{% url 'product_list' %}">–°–∫–ª–∞–¥</a>
                    {% if perms.warehouse2.view_workorder %}
                    <a class="nav-link" href="{% url 'workorder_list' %}">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</a>
                    {% endif %}
                    <a class="nav-link" href="{% url 'shipment_list' %}">–û—Ç–≥—Ä—É–∑–∫–∏</a>
                    <a class="nav-link" href="{% url 'count_list' %}">–ü–µ—Ä–µ—É—á–µ—Ç</a>
                    <a href="{% url 'reports_home' %}" class="nav-link">–û—Ç—á–µ—Ç—ã</a>
                </div>
            </div>
        </nav>
{% if messages %}
        <ul class="messages">
            {% for message in messages %}
            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
{% endif %}
    </header>
    {% block content %}
    {% endblock %}
</body>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Global scanner script initialized");
        
        const globalScanButton = document.getElementById('global-scan-btn');
        const globalSearchInput = document.querySelector('#filter-form input[name="q"]');
        const videoElement = document.getElementById('video-stream');
        const filterForm = document.getElementById('filter-form');
        
        if (!globalScanButton || !globalSearchInput || !videoElement || !filterForm) {
            console.error("Required elements for global scanner not found");
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ZXing
        if (typeof ZXing === 'undefined') {
            console.error("ZXing library not loaded");
            globalScanButton.disabled = true;
            globalScanButton.title = "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞";
            return;
        }
        
        const codeReader = new ZXing.BrowserMultiFormatReader();
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        if (isIOS || isSafari) {
            console.log("iOS/Safari detected - applying optimizations");
        }
        
        let isScanning = false;
        
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        const statusElement = document.createElement('div');
        statusElement.className = 'small text-muted mt-2';
        statusElement.style.display = 'none';
        statusElement.id = 'scanner-status';
        statusElement.style.textAlign = 'center';
        filterForm.appendChild(statusElement);
        
        globalScanButton.addEventListener('click', async function() {
            if (isScanning) {
                // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                stopScanner();
                return;
            }
            
            try {
                // –ù–∞—á–∞–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                console.log("Starting global barcode scanner...");
                globalScanButton.innerHTML = '‚èπ';
                globalScanButton.classList.add('btn-danger');
                globalScanButton.classList.remove('btn-outline-secondary');
                
                statusElement.textContent = '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ... –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥';
                statusElement.style.display = 'block';
                videoElement.style.display = 'block';
                isScanning = true;
                
                // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                if (isMobile) {
                    videoElement.style.width = '100%';
                    videoElement.style.maxWidth = '100%';
                    videoElement.style.objectFit = 'cover';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (!document.getElementById('mobile-hint')) {
                        const hint = document.createElement('div');
                        hint.id = 'mobile-hint';
                        hint.innerHTML = '<p class="text-center small mt-2">–î–µ—Ä–∂–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ 15-30 —Å–º –æ—Ç —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</p>';
                        videoElement.parentNode.insertBefore(hint, videoElement.nextSibling);
                    }
                }
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤
                const hints = new Map();
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                    ZXing.BarcodeFormat.EAN_13,
                    ZXing.BarcodeFormat.CODE_128,
                    ZXing.BarcodeFormat.UPC_A,
                    ZXing.BarcodeFormat.QR_CODE
                ]);

                // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è iOS
                if (isIOS || isSafari) {
                    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                    hints.set(ZXing.DecodeHintType.PURE_BARCODE, true);
                }

                const constraints = {
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                if (isIOS || isSafari) {
                    constraints.video.focusMode = "continuous";
                    constraints.video.advanced = [{ focusMode: "continuous" }];
                }
                
                // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
                await codeReader.decodeFromVideoDevice(
                    null, 
                    videoElement, 
                    (result, error) => {
                        if (result) {
                            console.log("Scanned barcode:", result.text);
                            globalSearchInput.value = result.text;
                            stopScanner();
                            
                            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
                            setTimeout(() => {
                                filterForm.submit();
                            }, 300);
                        }
                        if (error && !(error instanceof ZXing.NotFoundException)) {
                            console.error("Scan error:", error);
                            statusElement.textContent = '–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message;
                        }
                    },
                    hints,
                    constraints
                );
                
            } catch (error) {
                console.error("Scanner initialization error:", error);
                statusElement.textContent = '–û—à–∏–±–∫–∞: ' + error.message;
                stopScanner();
            }
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞
        function stopScanner() {
            if (isScanning) {
                codeReader.reset();
                videoElement.style.display = 'none';
                globalScanButton.innerHTML = 'üì∏';
                globalScanButton.classList.remove('btn-danger');
                globalScanButton.classList.add('btn-outline-secondary');
                statusElement.style.display = 'none';
                isScanning = false;
                
                // –£–¥–∞–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                const mobileHint = document.getElementById('mobile-hint');
                if (mobileHint) {
                    mobileHint.remove();
                }
                
                console.log("Global scanner stopped");
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', stopScanner);
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
        filterForm.addEventListener('submit', function() {
            if (isScanning) {
                stopScanner();
            }
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ API –∫–∞–º–µ—Ä—ã
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            globalScanButton.disabled = true;
            globalScanButton.title = "–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ";
            statusElement.textContent = '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ';
            statusElement.style.display = 'block';
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–µ–æ
        videoElement.style.borderRadius = '8px';
        videoElement.style.marginBottom = '1rem';
        videoElement.style.display = 'none';
    });
</script>
</html>