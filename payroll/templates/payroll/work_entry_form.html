{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <div class="col-md-6 offset-md-3">
        <div class="card shadow">
            <div class="card-header {% if work_type == 'piece' %}bg-primary{% else %}bg-warning{% endif %} text-white">
                <h4 class="mb-0">–í–≤–æ–¥: {{ work_type|title }}</h4>
            </div>
            <div class="card-body">
                <form method="post" id="work-form">
                    {% csrf_token %}

                    {% for field in form %}
                        {% if field.name == 'product' %}
                            <div class="d-none">{{ field }}</div>
                            
                            <div class="mb-3 position-relative">
                                <label class="form-label font-weight-bold">–ù–∞–π–¥–∏—Ç–µ –∏–∑–¥–µ–ª–∏–µ</label>
                                <div class="input-group">
                                    <input type="text" id="product-search-input" class="form-control form-control-lg" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –∞—Ä—Ç–∏–∫—É–ª –∏–ª–∏ –∫–æ–¥...">
                                    <button class="btn btn-outline-secondary" type="button" id="local-scan-btn">
                                        üì∏
                                    </button>
                                </div>
                                <div id="search-results" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                            </div>

                            <div id="local-scanner-container" class="mb-3" style="display: none;">
                                <video id="local-video-stream" style="width: 100%; border-radius: 8px; border: 2px solid #0d6efd;"></video>
                                <button type="button" class="btn btn-danger btn-sm w-100 mt-2" onclick="stopLocalScanner()">‚èπ –°—Ç–æ–ø</button>
                            </div>

                            <div id="selected-product-info" class="alert alert-info py-2 mb-3" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 id="selected-product-name" class="mb-0"></h6>
                                        <small id="selected-product-sku" class="text-muted"></small>
                                    </div>
                                    <button type="button" class="btn-close" id="clear-product" aria-label="Close"></button>
                                </div>
                            </div>

                        {% else %}
                            <div class="mb-3">
                                <label class="form-label font-weight-bold">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}<div class="text-danger small">{{ field.errors }}</div>{% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" id="submit-btn" class="btn btn-success btn-lg" {% if work_type == 'piece' %}disabled{% endif %}>
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
                        </button>
                        <a href="{% url 'worker_cabinet' %}" class="btn btn-link text-secondary">–ù–∞–∑–∞–¥</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const workType = "{{ work_type }}";
    if (workType !== 'piece') return;

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const searchInput = document.getElementById('product-search-input');
    const searchResults = document.getElementById('search-results');
    const hiddenProductInput = document.querySelector('select[name="product"]'); // Django —Å–µ–ª–µ–∫—Ç
    const operationSelect = document.querySelector('select[name="operation"]');
    const infoBlock = document.getElementById('selected-product-info');
    const infoName = document.getElementById('selected-product-name');
    const infoSku = document.getElementById('selected-product-sku');
    const submitBtn = document.getElementById('submit-btn');
    const clearBtn = document.getElementById('clear-product');

    // –°–∫–∞–Ω–µ—Ä
    const scanButton = document.getElementById('local-scan-btn');
    const scannerContainer = document.getElementById('local-scanner-container');
    const videoElement = document.getElementById('local-video-stream');
    let codeReader = null;
    const beepSound = new Audio("{% static 'sounds/bip.mp3' %}");

    // 1. –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞
    function selectProduct(product) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–∫—Ä—ã—Ç—ã–π Django-—Å–µ–ª–µ–∫—Ç
        hiddenProductInput.value = product.id;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ-–±–ª–æ–∫
        infoName.textContent = product.name;
        infoSku.textContent = `–ê—Ä—Ç–∏–∫—É–ª: ${product.sku}`;
        infoBlock.style.display = 'block';
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫
        searchInput.value = '';
        searchResults.style.display = 'none';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
        loadOperations(product.id);
        
        submitBtn.disabled = false;
        stopLocalScanner();
    }

    // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ —Ç–µ—Ö–∫–∞—Ä—Ç–µ
    function loadOperations(productId) {
        operationSelect.innerHTML = '<option>–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
        fetch(`/payroll/api/get-operations/?product_id=${productId}`)
            .then(r => r.json())
            .then(data => {
                operationSelect.innerHTML = '<option value="">--- –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é ---</option>';
                data.forEach(op => {
                    let opt = new Option(op.name, op.id);
                    operationSelect.add(opt);
                });
                operationSelect.focus(); // –ü–µ—Ä–µ–≤–æ–¥–∏–º —Ñ–æ–∫—É—Å –Ω–∞ –≤—ã–±–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–∏
            });
    }

    // 3. –†—É—á–Ω–æ–π –ø–æ–∏—Å–∫ AJAX
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 2) {
            searchResults.style.display = 'none';
            return;
        }

        fetch(`{% url 'product_search_json' %}?q=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(data => {
                searchResults.innerHTML = '';
                if (data.results.length > 0) {
                    data.results.forEach(p => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'list-group-item list-group-item-action';
                        btn.innerHTML = `<strong>${p.name}</strong> <small class="text-muted d-block">–ê—Ä—Ç: ${p.sku}</small>`;
                        btn.onclick = () => selectProduct(p);
                        searchResults.appendChild(btn);
                    });
                    searchResults.style.display = 'block';
                } else {
                    searchResults.innerHTML = '<div class="list-group-item text-muted">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    searchResults.style.display = 'block';
                }
            });
    });

    // 4. –õ–æ–≥–∏–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
    function startLocalScanner() {
        codeReader = new ZXing.BrowserMultiFormatReader();
        scannerContainer.style.display = 'block';
        codeReader.decodeFromVideoDevice(undefined, videoElement, (result, error) => {
            if (result) {
                beepSound.play().catch(() => {});
                // –ò—â–µ–º —Ç–æ–≤–∞—Ä –ø–æ –∫–æ–¥—É
                fetch(`{% url 'product_search_json' %}?q=${encodeURIComponent(result.text)}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.results.length > 0) selectProduct(data.results[0]);
                    });
            }
        });
    }

    window.stopLocalScanner = function() {
        if (codeReader) {
            codeReader.reset();
            codeReader = null;
        }
        scannerContainer.style.display = 'none';
    }

    scanButton.addEventListener('click', () => {
        scannerContainer.style.display === 'none' ? startLocalScanner() : stopLocalScanner();
    });

    clearBtn.addEventListener('click', () => {
        infoBlock.style.display = 'none';
        hiddenProductInput.value = '';
        operationSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>';
        submitBtn.disabled = true;
    });
});
</script>
{% endblock %}