{% extends 'base.html' %}
{% block content %}

<div class="container mt-4">
    <h2>{{ operation_name }} –º–∞—Ç–µ—Ä–∏–∞–ª–∞</h2>
    <hr>

    <form method="get" class="mb-4">
        <div class="row">
            <div class="col-md-4"> {{ search_form.name }}</div>
            <div class="col-md-4"> {{ search_form.article }}</div>
            <div class="col-md-4">
                
                <div class="input-group">
                    <input type="text" name="barcode" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥" id="id_barcode">
                    <button type="button" class="btn btn-outline-secondary" id="scan-btn">
                        üì∏ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary mt-3">–ù–∞–π—Ç–∏</button>
    </form>
    <div id="scanner-status" class="small text-muted mt-1" style="display: none;">
        –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ... –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥
    </div>
    <video id="video-stream" style="display: none; width: 100%; max-width: 400px; border-radius: 8px;"></video>

    {% if material_forms %}
        <h4 class="mt-5">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                    <th>–ù–∞ —Å–∫–ª–∞–¥–µ</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    {% if operation_type == 'outgoing' %}
                    <th>–ö—É–¥–∞ –≤—ã–¥–∞–µ–º</th>
                    {% endif %}
                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                    <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                </tr>
            </thead>
            <tbody>
                {% for item in material_forms %}
                <tr>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="material_id" value="{{ item.material.id }}">
                        
                        <td><a href="{% url 'material_detail' item.material.pk %}">{{ item.material.name }}</a></td>
                        <td>{{ item.material.article }}</td>
                        <td>{{ item.material.quantity }} {{ item.material.unit.short_name }}</td>
                        <td>{{ item.form.quantity }}</td>
                        {% if operation_type == 'outgoing' %}
                        <td>{{ item.form.outgoing_category }}</td>
                        {% endif %}
                        <td>{{ item.form.comment }}</td>
                        
                        <td>
                            <button type="submit" class="btn btn-success">
                                {% if operation_type == 'incoming' %}–ü—Ä–∏–Ω—è—Ç—å{% else %}–í—ã–¥–∞—Ç—å{% endif %}
                            </button>
                        </td>
                    </form>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% elif request.GET.name or request.GET.article or request.GET.barcode %}
        <p class="text-muted">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
    {% endif %}
</div>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Scanner script initialized");
        
        const scanButton = document.getElementById('scan-btn');
        const barcodeInput = document.getElementById('id_barcode');
        const videoElement = document.getElementById('video-stream');
        const searchForm = document.querySelector('form[method="get"]');
        
        if (!scanButton || !barcodeInput || !videoElement || !searchForm) {
            console.error("Required elements not found");
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        if (typeof ZXing === 'undefined') {
            console.error("ZXing library not loaded");
            alert("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
            return;
        }
        
        const codeReader = new ZXing.BrowserMultiFormatReader();
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        if (isMobile) {
            console.log("Mobile device detected - adjusting scanner settings");
        }
        let isScanning = false;
        
        scanButton.addEventListener('click', async function() {
            if (isScanning) {
                // –ï—Å–ª–∏ —É–∂–µ —Å–∫–∞–Ω–∏—Ä—É–µ–º, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                codeReader.reset();
                videoElement.style.display = 'none';
                scanButton.textContent = 'üì∏ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å';
                isScanning = false;
                return;
            }
            
            try {
                console.log("Starting scanner...");
                scanButton.textContent = '‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                videoElement.style.display = 'block';
                isScanning = true;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞ (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥ –≤–∞—à–∏ –Ω—É–∂–¥—ã)
                const hints = new Map();
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                    ZXing.BarcodeFormat.CODE_128,  // –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π
                    ZXing.BarcodeFormat.EAN_13,
                    ZXing.BarcodeFormat.QR_CODE
                ]);

                if (isMobile) {
                    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                    hints.set(ZXing.DecodeHintType.ASSUME_GS1, true);
                }

                const constraints = {
                    video: {
                        facingMode: "environment",
                        width: { min: 640, ideal: 1280 },
                        height: { min: 480, ideal: 720 }
                    }
                };

                if (isSafari) {
                    constraints.video.focusMode = "continuous";
                    constraints.video.advanced = [{ focusMode: "continuous" }];
                }

                await codeReader.decodeFromVideoDevice(
                    null,
                    videoElement,
                    (result, error) => {
                        // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞...
                    },
                    hints,
                    constraints  // –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
                );              
                // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
                const result = await codeReader.decodeFromVideoDevice(
                    null, 
                    videoElement, 
                    (result, error) => {
                        if (result) {
                            console.log("Scanned barcode:", result.text);
                            barcodeInput.value = result.text;
                            codeReader.reset();
                            videoElement.style.display = 'none';
                            scanButton.textContent = 'üì∏ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å';
                            isScanning = false;
                            searchForm.submit();
                        }
                        if (error && !(error instanceof ZXing.NotFoundException)) {
                            console.error("Scan error:", error);
                        }
                    },
                    hints
                );
            } catch (error) {
                console.error("Scanner error:", error);
                alert("–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞: " + error.message);
                codeReader.reset();
                videoElement.style.display = 'none';
                scanButton.textContent = 'üì∏ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å';
                isScanning = false;
            }
        });
    });

    if (isMobile) {
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    videoElement.style.width = '100%';
    videoElement.style.maxWidth = '100%';
    videoElement.style.objectFit = 'cover';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const hint = document.createElement('div');
    hint.innerHTML = '<p class="text-center small mt-2">–î–µ—Ä–∂–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ 15-30 —Å–º –æ—Ç —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</p>';
    videoElement.parentNode.insertBefore(hint, videoElement.nextSibling);
}
</script>
{% endblock %}