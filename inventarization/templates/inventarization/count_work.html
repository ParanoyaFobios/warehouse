{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h2>–ü–µ—Ä–µ—É—á–µ—Ç ‚Ññ{{ inventory_count.id }}</h2>

        {% if inventory_count.status == 'in_progress' and items %}
        <form action="{% url 'count_complete' inventory_count.pk %}" method="post" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-warning">–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–µ—Ä–µ—É—á–µ—Ç</button>
        </form>
        {% endif %}
    </div>
    <p>–°—Ç–∞—Ç—É—Å: <span class="badge bg-{% if inventory_count.status == 'in_progress' %}warning{% else %}success{% endif %}">{{ inventory_count.get_status_display }}</span></p>
    <hr>
    
    <div class="row">
        {% if inventory_count.status == 'in_progress' %}
        <div class="col-lg-5">
            <div class="card sticky-top" style="top: 20px; z-index: 100;">
                <div class="card-header"><h4>–î–æ–±–∞–≤–∏—Ç—å/–ù–∞–π—Ç–∏ –ø–æ–∑–∏—Ü–∏—é</h4></div>
                <div class="card-body">
                    <form method="post" id="add-item-form">
                        {% csrf_token %}
                        {{ form.item_identifier }}
                        <div class="mb-3 position-relative">
                            <label class="form-label">–ü–æ–∏—Å–∫</label>
                            <div class="input-group">
                                <input type="text" id="stock-search-input" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –∞—Ä—Ç–∏–∫—É–ª, —à—Ç—Ä–∏—Ö–∫–æ–¥..." autocomplete="off">
                                <button id="scan-btn" style="min-width: 50px" class="btn btn-outline-secondary" type="button" title="–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å">üì∏</button>
                            </div>
                            <div id="search-results" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                        </div>
                        <div class="mb-3">
                            {{ form.quantity.label_tag }}
                            {{ form.quantity }}
                        </div>
                        <button type="submit" class="btn btn-success w-100">–î–æ–±–∞–≤–∏—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="{% if inventory_count.status == 'in_progress' %}col-lg-7{% else %}col-lg-12{% endif %} mt-4 mt-lg-0">
            <h4>–í–Ω–µ—Å–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ ({{ items.count }})</h4>
            {% for item in items %}
            <div class="card mb-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <strong>{{ item.content_object.name }}</strong>
                            {% if perms.inventarization.can_reconcile_inventory %}
                            <br><small class="text-muted">–°–∏—Å—Ç–µ–º–∞: {{ item.system_quantity }} | –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ: <span class="fw-bold {% if item.variance > 0 %}text-success{% elif item.variance < 0 %}text-danger{% endif %}">{% if item.variance > 0 %}+{% endif %}{{ item.variance }}</span></small>
                            {% endif %}
                        </div>
                        <div class="col-md-5 text-end">
                            {% if inventory_count.status == 'in_progress' %}
                            <div class="d-flex gap-2 align-items-center justify-content-end">
                                <form action="{% url 'item_update' item.pk %}" method="post" class="d-flex gap-2">
                                    {% csrf_token %}
                                    {{ item.update_form.quantity }}
                                </form>
                                <form action="{% url 'item_delete' item.pk %}" method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger">√ó</button>
                                </form>
                            </div>
                            {% else %}
                            <p class="mb-0"><strong>–§–∞–∫—Ç: {{ item.actual_quantity }}</strong></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-muted">–ï—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏.</p>
            {% endfor %}
        </div>
    </div>
</div>

<div id="scanner-container" style="display: none;">
    <div class="scanner-content">
        <video id="inventory-video-stream"></video>
        <div class="scanner-laser"></div> <div id="scanner-status" class="small text-white text-center mt-2">–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥</div>
        <button id="close-scanner-btn" class="btn btn-danger btn-sm w-100 mt-3"  onclick="stopLocalScanner()">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>
</div>

<style>
/* –°—Ç–∏–ª–∏ –∏–∑ —Ä–∞–±–æ—á–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –≤–∏–¥–µ–æ */
#scanner-container {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
}

.scanner-content {
    position: relative;
    width: 90%;
    max-width: 500px;
    background: #000;
    padding: 10px;
    border-radius: 10px;
}

#inventory-video-stream {
    width: 100%;
    height: 50%;
    min-height: 200px; /* –ß—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Å—Ö–ª–æ–ø—ã–≤–∞–ª—Å—è –≤ 0 */
    background-color: #222; /* –°–µ—Ä—ã–π —Ñ–æ–Ω, —á—Ç–æ–±—ã –æ—Ç–ª–∏—á–∏—Ç—å –æ—Ç —á–µ—Ä–Ω–æ–≥–æ –∑–∞–≤–∏—Å–∞–Ω–∏—è */
    border-radius: 5px;
    display: block;
    object-fit: cover; /* –í–∞–∂–Ω–æ: –∑–∞–ø–æ–ª–Ω—è–µ—Ç –≤—Å—ë –æ–∫–Ω–æ –±–µ–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π */
}

/* –î–æ–±–∞–≤–∏–º —Å—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç —á–µ–º-—Ç–æ –Ω–µ–≤–∏–¥–∏–º—ã–º */
.scanner-content {
    z-index: 10001; 
    position: relative;
}

.scanner-laser {
    position: absolute;
    top: 50%; left: 10%; right: 10%;
    height: 2px;
    background: red;
    box-shadow: 0 0 8px red;
    animation: scanning 2s infinite;
}

@keyframes scanning {
    0% { top: 20%; }
    50% { top: 80%; }
    100% { top: 20%; }
}

#search-results {
    background: white;
    border: 1px solid #ddd;
    display: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('stock-search-input');
    const searchResults = document.getElementById('search-results');
    const mainForm = document.getElementById('add-item-form');
    const identifierInput = document.getElementById('id_item_identifier');
    const quantityInput = document.getElementById('id_quantity');
    const scanButton = document.getElementById('scan-btn');
    const inventoryCountId = "{{ inventory_count.id }}";
    
    const scannerContainer = document.getElementById('scanner-container');
    const videoElement = document.getElementById('inventory-video-stream');
    const closeScannerBtn = document.getElementById('close-scanner-btn');
    const scannerStatus = document.getElementById('scanner-status');

    let codeReader = null;
    let overlay = null;
    // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –∑–≤—É–∫ –∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–º —Å–∫—Ä–∏–ø—Ç–µ
    const beepSound = new Audio("{% static 'sounds/bip.mp3' %}");

    function performManualSearch(query) {
        if (query.length < 2) {
            searchResults.style.display = 'none';
            return;
        }
        const fetchUrl = `{% url 'inventory_stock_search' %}?q=${encodeURIComponent(query)}&inventory_count_id=${inventoryCountId}`;
        
        fetch(fetchUrl)
            .then(r => r.json())
            .then(data => {
                searchResults.innerHTML = '';
                if (data.results && data.results.length > 0) {
                    data.results.forEach(item => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'list-group-item list-group-item-action';
                        btn.innerHTML = `<strong>${item.name}</strong><br><small class="text-muted">${item.info}</small>`;
                        btn.onclick = () => {
                            identifierInput.value = item.id;
                            searchInput.value = item.name;
                            quantityInput.value = item.counted_quantity;
                            searchResults.style.display = 'none';
                            quantityInput.focus();
                        };
                        searchResults.appendChild(btn);
                    });
                    searchResults.style.display = 'block';
                }
            });
    }

    searchInput.addEventListener('input', () => performManualSearch(searchInput.value.trim()));

    function processScannedBarcode(barcode) {
        scannerStatus.textContent = "–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞...";
        const fetchUrl = `{% url 'inventory_stock_search' %}?q=${encodeURIComponent(barcode)}&inventory_count_id=${inventoryCountId}`;
        
        fetch(fetchUrl)
            .then(r => r.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    const found = data.results[0];
                    identifierInput.value = found.id;
                    searchInput.value = found.name;
                    quantityInput.value = found.counted_quantity;
                    stopScanner(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
                    quantityInput.focus();
                } else {
                    alert("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    stopScanner();
                }
            });
    }

    function startScanner() {
        if (typeof ZXing === 'undefined') return alert("–û—à–∏–±–∫–∞: ZXing –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
        
        beepSound.load();
        scannerContainer.style.display = 'flex';
        
        // –°–æ–∑–¥–∞–µ–º —Ä–∏–¥–µ—Ä, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω
        if (!codeReader) {
            codeReader = new ZXing.BrowserMultiFormatReader();
        }

        // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–º–µ–Ω–Ω–æ –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã
        const constraints = {
            video: {
                facingMode: { exact: "environment" }, // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å –∏–¥–µ–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ (–∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞)
        codeReader.decodeFromConstraints(constraints, videoElement, (result, error) => {
            if (result) {
                beepSound.play().catch(() => {});
                processScannedBarcode(result.text);
            }
            if (error && !(error instanceof ZXing.NotFoundException)) {
                console.error("–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞:", error);
            }
        })
        .catch(err => {
            // –ï—Å–ª–∏ "facingMode: environment" –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ –ü–ö –Ω–µ—Ç –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã), 
            // –∑–∞–ø—É—Å–∫–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø–æ—Ç–æ–∫
            console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É, –ø—Ä–æ–±—É–µ–º –ª—é–±—É—é:", err);
            codeReader.decodeFromVideoDevice(undefined, videoElement, (result, error) => {
                if (result) {
                    beepSound.play().catch(() => {});
                    processScannedBarcode(result.text);
                }
            });
        });
    }

    function stopScanner() {
        if (codeReader) {
            codeReader.reset();
            codeReader = null;
        }
        scannerContainer.style.display = 'none';
    }

    scanButton.addEventListener('click', startScanner);
    closeScannerBtn.addEventListener('click', stopScanner);

    // –°–∫—Ä—ã—Ç–∏–µ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
    document.addEventListener('click', (e) => {
        if (!searchResults.contains(e.target) && e.target !== searchInput) {
            searchResults.style.display = 'none';
        }
    });
});
</script>
{% endblock %}