{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h2>–ü–µ—Ä–µ—É—á–µ—Ç ‚Ññ{{ inventory_count.id }}</h2>

        {% if inventory_count.status == 'in_progress' and items %}
        <form action="{% url 'count_complete' inventory_count.pk %}" method="post" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-warning">–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–µ—Ä–µ—É—á–µ—Ç</button>
        </form>
        {% endif %}
    </div>
    <p>–°—Ç–∞—Ç—É—Å: <span class="badge bg-{% if inventory_count.status == 'in_progress' %}warning{% else %}success{% endif %}">{{ inventory_count.get_status_display }}</span></p>
    <hr>
    <div class="row">
        {% if inventory_count.status == 'in_progress' %}
        <div class="col-lg-5">
            <div class="card sticky-top">
                <div class="card-header"><h4>–î–æ–±–∞–≤–∏—Ç—å/–ù–∞–π—Ç–∏ –ø–æ–∑–∏—Ü–∏—é</h4></div>
                <div class="card-body">
                    <form method="post" id="add-item-form">
                        {% csrf_token %}
                        {{ form.item_identifier }}
                        <div class="mb-3 position-relative">
                            <label class="form-label">–ü–æ–∏—Å–∫</label>
                            <div class="input-group">
                                <input type="text" id="stock-search-input" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –∞—Ä—Ç–∏–∫—É–ª, —à—Ç—Ä–∏—Ö–∫–æ–¥..." autocomplete="off">
                                <button id="scan-btn" class="btn btn-outline-secondary" type="button">üì∏</button>
                            </div>
                            <div id="search-results" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                        </div>
                        <div class="mb-3">
                            {{ form.quantity.label_tag }}
                            {{ form.quantity }}
                        </div>
                        <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="{% if inventory_count.status == 'in_progress' %}col-lg-7{% else %}col-lg-12{% endif %}">
            <h4>–í–Ω–µ—Å–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ ({{ items.count }})</h4>
            {% for item in items %}
            <div class="card mb-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <strong>{{ item.content_object.name }}</strong>
                            {% if user.is_superuser or user.is_staff %}
                            <br><small class="text-muted">–°–∏—Å—Ç–µ–º–∞: {{ item.system_quantity }} | –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ: <span class="fw-bold {% if item.variance > 0 %}text-success{% elif item.variance < 0 %}text-danger{% endif %}">{% if item.variance > 0 %}+{% endif %}{{ item.variance }}</span></small>
                            {% endif %}
                        </div>
                        <div class="col-md-5">
                            {% if inventory_count.status == 'in_progress' %}
                            <div class="d-flex gap-2 align-items-center">
                                <form action="{% url 'item_update' item.pk %}" method="post" class="flex-grow-1 d-flex gap-2">
                                    {% csrf_token %}
                                    {{ item.update_form.quantity }}
                                    <button type="submit" class="btn btn-sm btn-primary">OK</button>
                                </form>
                                <form action="{% url 'item_delete' item.pk %}" method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger">√ó</button>
                                </form>
                            </div>
                            {% else %}
                            <p class="mb-0 text-end"><strong>–§–∞–∫—Ç: {{ item.actual_quantity }}</strong></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-muted">–ï—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏.</p>
            {% endfor %}
        </div>
    </div>
</div>

<div id="scanner-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; flex-direction: column; align-items: center; justify-content: center;">
    <video id="video-stream" style="width: 80%; max-width: 600px; border-radius: 8px;"></video>
    <button id="close-scanner-btn" class="btn btn-danger mt-3">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã ---
    const searchInput = document.getElementById('stock-search-input');
    const searchResults = document.getElementById('search-results');
    const mainForm = document.getElementById('add-item-form');
    const identifierInput = document.getElementById('id_item_identifier');
    const quantityInput = document.getElementById('id_quantity');
    const scanButton = document.getElementById('scan-btn');
    const inventoryCountId = {{ inventory_count.id }};
    
    const scannerContainer = document.getElementById('scanner-container');
    const videoElement = document.getElementById('video-stream');
    const closeScannerBtn = document.getElementById('close-scanner-btn');
    let codeReader = null;

    // --- –õ–æ–≥–∏–∫–∞ –†–£–ß–ù–û–ì–û –ü–û–ò–°–ö–ê ---
    function performManualSearch(query) {
        if (query.length < 2) {
            searchResults.style.display = 'none';
            return;
        }
        const fetchUrl = `{% url 'inventory_stock_search' %}?q=${encodeURIComponent(query)}&inventory_count_id=${inventoryCountId}`;
        
        fetch(fetchUrl)
            .then(response => response.json())
            .then(data => {
                searchResults.innerHTML = '';
                if (data.results && data.results.length > 0) {
                    data.results.forEach(item => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'list-group-item list-group-item-action search-result-item';
                        btn.dataset.id = item.id;
                        btn.dataset.name = item.name;
                        btn.dataset.counted = item.counted_quantity;
                        btn.innerHTML = `<strong>${item.name}</strong><br><small class="text-muted">${item.info}</small>`;
                        searchResults.appendChild(btn);
                    });
                } else {
                    searchResults.innerHTML = '<div class="list-group-item text-muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                }
                searchResults.style.display = 'block';
            });
    }

    searchResults.addEventListener('click', function(event) {
        const target = event.target.closest('.search-result-item');
        if (target) {
            identifierInput.value = target.dataset.id;
            searchInput.value = target.dataset.name;
            quantityInput.value = target.dataset.counted;
            quantityInput.focus();
            searchResults.style.display = 'none';
        }
    });

    searchInput.addEventListener('input', () => performManualSearch(searchInput.value.trim()));

    // --- –õ–æ–≥–∏–∫–∞ –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø ---
    function processScannedBarcode(barcode) {
        const fetchUrl = `{% url 'inventory_stock_search' %}?q=${encodeURIComponent(barcode)}&inventory_count_id=${inventoryCountId}`;
        
        fetch(fetchUrl)
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    const foundItem = data.results[0];
                    identifierInput.value = foundItem.id;
                    searchInput.value = foundItem.name;
                    quantityInput.value = foundItem.counted_quantity;
                    quantityInput.focus();
                } else {
                    alert("–¢–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                }
            });
    }

    function startScanner() {
        if (typeof ZXing === 'undefined') return alert("–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.");
        
        codeReader = new ZXing.BrowserMultiFormatReader();
        scannerContainer.style.display = 'flex';

        codeReader.decodeFromVideoDevice(undefined, videoElement, (result, error) => {
            if (result) {
                stopScanner();
                processScannedBarcode(result.text);
            }
            if (error && !(error instanceof ZXing.NotFoundException)) {
                console.error("Scan error:", error);
            }
        });
    }

    function stopScanner() {
        if (codeReader) {
            codeReader.reset();
            scannerContainer.style.display = 'none';
        }
    }

    scanButton.addEventListener('click', startScanner);
    closeScannerBtn.addEventListener('click', stopScanner);

    // –°–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
    document.addEventListener('click', function(e) {
        if (searchResults && !searchResults.contains(e.target) && e.target !== searchInput) {
            searchResults.style.display = 'none';
        }
    });
});
</script>
{% endblock %}