{% extends "base.html" %}
{% block content %}
{% load static %}
<div class="container mt-4">
    <div class="col-md-8 offset-md-2">
        <h2>–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏</h2>
        <div class="card">
            <div class="card-body">
                <form method="post" id="incoming-form">
                    {% csrf_token %}
                    {{ form.product }}

                    <div class="mb-3 position-relative">
                        <label for="product-search-input" class="form-label">–ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</label>
                        <div class="input-group">
                            <input type="text" id="product-search-input" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞—Ä—Ç–∏–∫—É–ª—É, —à—Ç—Ä–∏—Ö–∫–æ–¥—É...">
                            <button class="btn btn-outline-secondary" type="button" id="local-scan-btn" title="–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥">
                                üì∏
                            </button>
                        </div>
                        <div id="search-results" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                    </div>
                    
                    <div id="local-scanner-container" class="mb-3" style="display: none;">
                        <video id="local-video-stream" style="width: 100%; max-width: 400px; border-radius: 8px; border: 2px solid #198754;"></video>
                        <div id="local-scanner-status" class="small text-muted text-center mt-2"></div>
                        <button type="button" class="btn btn-danger btn-sm w-100 mt-2" onclick="stopLocalScanner()">
                            ‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                        </button>
                    </div>

                    <div id="selected-product-info" class="alert alert-info" style="display: none;">
                        <h5 id="selected-product-name"></h5>
                        <p class="mb-0">–ê—Ä—Ç–∏–∫—É–ª: <strong id="selected-product-sku"></strong></p>
                        {% if user.is_superuser or user.is_staff  %}
                        <p class="mb-0">–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: <strong id="selected-product-available"></strong> —à—Ç.</p>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.quantity.id_for_label }}" class="form-label">{{ form.quantity.label }}</label>
                        {{ form.quantity }}
                    </div>
                     <div class="mb-3">
                        <label for="{{ form.comment.id_for_label }}" class="form-label">{{ form.comment.label }}</label>
                        {{ form.comment }}
                    </div>

                    <button type="submit" class="btn btn-success mt-3">–ü—Ä–∏–Ω—è—Ç—å –Ω–∞ —Å–∫–ª–∞–¥</button>
                </form>
            </div>
        </div>
    </div>
</div>
<style>
    #search-results {
        display: none;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
    
    #search-results:not(:empty) {
        display: block;
    }
    
    .list-group-item {
        cursor: pointer;
        border: none;
        border-bottom: 1px solid #dee2e6;
    }
    
    .list-group-item:last-child {
        border-bottom: none;
    }
    
    .list-group-item:hover {
        background-color: #f8f9fa;
    }
    
    .table th, .table td {
        vertical-align: middle;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞ */
    #local-scanner-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        z-index: 9999;
        max-width: 90vw;
    }
    
    #local-video-stream {
        max-height: 60vh;
    }
    
    /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ */
    .scanner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 9998;
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
        const searchInput = document.getElementById('product-search-input');
        const searchResults = document.getElementById('search-results');
        const hiddenProductInput = document.getElementById('id_product');
        const quantityInput = document.getElementById('id_quantity'); // –ü–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        const submitButton = document.querySelector('button[type="submit"]');
    
        // 2. –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ñ–æ-–±–ª–æ–∫–∞
        const infoBlock = document.getElementById('selected-product-info');
        const infoName = document.getElementById('selected-product-name');
        const infoSku = document.getElementById('selected-product-sku');
        const infoAvailable = document.getElementById('selected-product-available');
    
        // 3. –≠–ª–µ–º–µ–Ω—Ç—ã —Å–∫–∞–Ω–µ—Ä–∞
        const scanButton = document.getElementById('local-scan-btn');
        const scannerContainer = document.getElementById('local-scanner-container');
        const videoElement = document.getElementById('local-video-stream');
        const scannerStatus = document.getElementById('local-scanner-status');
        
        let codeReader = null;
        const beepSound = new Audio("{% static 'sounds/bip.mp3' %}");
    
        // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞ (–æ–±—â–∞—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Å–∫–∞–Ω–µ—Ä–∞)
        function selectProduct(product) {
            hiddenProductInput.value = product.id;
            infoName.textContent = product.name;
            infoSku.textContent = product.sku;
            
            if (infoAvailable) {
                infoAvailable.textContent = product.available_quantity;
            }
            
            infoBlock.style.display = 'block';
            searchInput.value = '';
            searchResults.style.display = 'none';
            submitButton.disabled = false;
    
            // –§–û–ö–£–° –ù–ê –ö–û–õ–ò–ß–ï–°–¢–í–û: —á—Ç–æ–±—ã –º–µ–Ω–µ–¥–∂–µ—Ä —Å—Ä–∞–∑—É –≤–≤–µ–ª —á–∏—Å–ª–æ
            setTimeout(() => quantityInput.focus(), 100);
        }
    
        // --- –õ–û–ì–ò–ö–ê –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø ---
    
        function processScannedBarcode(barcode) {
            scannerStatus.textContent = `–ü–æ–∏—Å–∫ –∫–æ–¥–∞: ${barcode}...`;
            
            fetch(`{% url 'product_search_json' %}?q=${encodeURIComponent(barcode)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        const product = data.results[0]; // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        
                        beepSound.play().catch(e => console.warn("–ó–≤—É–∫ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:", e));
                        
                        selectProduct(product);
                        stopLocalScanner(); 
                    } else {
                        scannerStatus.textContent = '‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ';
                    }
                })
                .catch(err => {
                    console.error(err);
                    scannerStatus.textContent = ' –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –±–∞–∑–æ–π';
                });
        }
    
        function startLocalScanner() {
            if (typeof ZXing === 'undefined') {
                return alert("–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ ZXing –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.");
            }
            
            beepSound.load(); // –ü—Ä–æ–≥—Ä–µ–≤ –∞—É–¥–∏–æ
            codeReader = new ZXing.BrowserMultiFormatReader();
            scannerContainer.style.display = 'block';
            scannerStatus.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞...';
    
            codeReader.decodeFromVideoDevice(undefined, videoElement, (result, error) => {
                if (result) {
                    processScannedBarcode(result.text);
                }
            });
        }
    
        window.stopLocalScanner = function() {
            if (codeReader) {
                codeReader.reset();
                codeReader = null;
            }
            scannerContainer.style.display = 'none';
        }
    
        scanButton.addEventListener('click', function() {
            if (scannerContainer.style.display === 'none') {
                startLocalScanner();
            } else {
                stopLocalScanner();
            }
        });
    
        // --- –†–£–ß–ù–û–ô –ü–û–ò–°–ö (–æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∞—à—É –ª–æ–≥–∏–∫—É) ---
    
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }
    
            fetch(`{% url 'product_search_json' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    searchResults.innerHTML = '';
                    if (data.results.length > 0) {
                        data.results.forEach(product => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action';
                            item.innerHTML = `<strong>${product.name}</strong> <small class="text-muted">(${product.sku})</small>`;
                            item.onclick = () => selectProduct(product);
                            searchResults.appendChild(item);
                        });
                    } else {
                        searchResults.innerHTML = '<div class="list-group-item text-muted">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    }
                    searchResults.style.display = 'block';
                });
        });
    
        document.addEventListener('click', function(e) {
            if (!searchResults.contains(e.target) && e.target !== searchInput) {
                searchResults.style.display = 'none';
            }
        });
});
</script>
{% endblock %}