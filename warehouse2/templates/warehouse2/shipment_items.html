{% extends "base.html" %}
{% load static %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@latest"></script>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –£–ø–∞–∫–æ–≤–∫–æ–π ‚Ññ{{ shipment.id }} <small class="text-muted">({{shipment.barcode}})</small></h2>
            
            <div class="card mb-4">
                <div class="card-header"><h5>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h5></div>
                <div class="card-body">
                    <form method="post" id="shipment-item-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">{{ form.product_search.label }}</label>
                            <div class="input-group">
                                {{ form.product_search }}
                                <button type="button" class="btn btn-outline-secondary" id="scan-product-btn">üì∏</button>
                            </div>
                            <div id="search-results" class="mt-2" style="display: none; position: absolute; z-index: 1000; width: 95%;">
                                <div class="list-group" id="search-results-list"></div>
                            </div>
                        </div>

                        <video id="video-stream" style="display: none; width: 100%; max-width: 400px; border-radius: 8px;"></video>
                        {{ form.product }}
                        
                        <div id="selected-product-info" class="card bg-light mb-3" style="display: none;">
                            <div class="card-body">
                                <h6 id="selected-product-name" class="card-title"></h6>
                                <p id="selected-product-available" class="mb-0 text-muted small"></p>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                            {{ form.quantity }}
                        </div>
                        
                        <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                        <a href="{% url 'shipment_detail' shipment.pk %}" class="btn btn-secondary">–ù–∞–∑–∞–¥ –∫ —É–ø–∞–∫–æ–≤–∫–µ</a>
                    </form>
                </div>
            </div>
            </div>
        <div class="col-md-4">
            </div>
    </div>
    {% if items %}
    <table class="table">
        <thead>
            <tr>
                <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                {% if shipment.can_be_edited %}
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for item in shipment.shipmentitem_set.all %}
            <tr>
                <td>{{ item.product.name }}</td>
                <td>{{ item.product.sku }}</td>
                <td>{{ item.quantity }} —à—Ç.</td>
                {% if shipment.can_be_edited %}
                <td>
                    <a href="{% url 'delete_shipment_item' item.pk %}" class="btn btn-sm btn-danger">–£–¥–∞–ª–∏—Ç—å</a>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">–¢–æ–≤–∞—Ä—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
    {% endif %}
</div>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // –ü–µ—Ä–µ–∏–º–µ–Ω—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –Ω–µ <select>
        const productInput = document.getElementById('id_product'); // –°–∫—Ä—ã—Ç—ã–π <input>
        
        // –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        const searchInput = document.getElementById('id_product_search');
        const searchResults = document.getElementById('search-results');
        const resultsList = document.getElementById('search-results-list');
        const selectedProductInfo = document.getElementById('selected-product-info');
        const selectedProductName = document.getElementById('selected-product-name');
        const selectedProductAvailable = document.getElementById('selected-product-available');
        
        let searchTimeout;
    
        // --- –§–£–ù–ö–¶–ò–Ø –í–´–ë–û–†–ê –ü–†–û–î–£–ö–¢–ê (–ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï) ---
        function selectProduct(product) {
            // üëáüëáüëá –í–û–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï üëáüëáüëá
            // –ü—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ ID –≤ –Ω–∞—à —Å–∫—Ä—ã—Ç—ã–π –∏–Ω–ø—É—Ç.
            productInput.value = product.id;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ç–æ–≤–∞—Ä–µ (—ç—Ç–æ—Ç –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
            selectedProductName.textContent = product.name;
            selectedProductAvailable.textContent = `–î–æ—Å—Ç—É–ø–Ω–æ: ${product.available_quantity} —à—Ç.`;
            selectedProductInfo.style.display = 'block';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫
            searchResults.style.display = 'none';
            searchInput.value = '';
            console.log(`Product with ID ${productInput.value} selected.`); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
        }
    
        // --- –ü–û–ò–°–ö –ü–û –¢–ï–ö–°–¢–£ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(() => {
                fetch(`{% url 'available_product_search' %}?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        resultsList.innerHTML = '';
                        if (data.results && data.results.length > 0) {
                            data.results.forEach(product => {
                                const item = document.createElement('button');
                                item.type = 'button';
                                item.className = 'list-group-item list-group-item-action';
                                item.innerHTML = `<strong>${product.name}</strong>`;
                                item.addEventListener('click', () => selectProduct(product));
                                resultsList.appendChild(item);
                            });
                        } else {
                            resultsList.innerHTML = `<div class="list-group-item text-muted">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>`;
                        }
                        searchResults.style.display = 'block';
                    })
                    .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ:', error));
            }, 300);
        });
    
        // --- –õ–û–ì–ò–ö–ê –°–ö–ê–ù–ï–†–ê (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        const codeReader = new ZXingBrowser.BrowserMultiFormatReader();
        const scanButton = document.getElementById('scan-product-btn');
        const videoElement = document.getElementById('video-stream');
    
        scanButton.addEventListener('click', () => {
            videoElement.style.display = 'block';
            codeReader.decodeFromVideoDevice(undefined, videoElement, (result, err) => {
                if (result) {
                    const barcode = result.getText();
                    codeReader.reset();
                    videoElement.style.display = 'none';
    
                    fetch(`{% url 'available_product_search' %}?q=${encodeURIComponent(barcode)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.results && data.results.length > 0) {
                                selectProduct(data.results[0]);
                            } else {
                                alert('–¢–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
                            }
                        });
                }
                if (err && !(err instanceof ZXingBrowser.NotFoundException)) {
                    console.error(err);
                }
            });
        });
    
        // --- –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        document.addEventListener('click', (e) => {
            if (!searchResults.contains(e.target) && !searchInput.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });
    });
    </script>
{% endblock %}