{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <h2>Управление товарами для отгрузки №{{ shipment.id }}</h2>
    <p>Пункт назначения: <strong>{{ shipment.destination }}</strong></p>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header"><h4>Добавить позицию</h4></div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        {{ form.item_identifier }}

                        <div class="mb-3">
                            <label class="form-label">Поиск по товарам и упаковкам</label>
                            <input type="text" id="stock-search-input" class="form-control" placeholder="Начните вводить название...">
                            <div id="search-results" class="list-group mt-1" style="position: absolute; z-index: 1000; width: 95%;"></div>
                        </div>

                        <div id="selected-item-info" class="alert alert-info" style="display: none;">
                            <strong id="selected-item-name"></strong>
                            <p id="selected-item-details" class="mb-0 small"></p>
                        </div>
                        
                        <div class="mb-3">{{ form.quantity.label_tag }} {{ form.quantity }}</div>
                        
                        <button type="submit" class="btn btn-success">Добавить</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <h4>Текущие позиции</h4>
            <table class="table">
                </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('stock-search-input');
    const searchResults = document.getElementById('search-results');
    const identifierInput = document.getElementById('id_item_identifier');
    
    const selectedInfo = document.getElementById('selected-item-info');
    const selectedName = document.getElementById('selected-item-name');
    const selectedDetails = document.getElementById('selected-item-details');

    function selectItem(item) {
        identifierInput.value = item.id; // "product-1" или "package-5"
        selectedName.textContent = item.name;
        selectedDetails.textContent = item.info;
        selectedInfo.style.display = 'block';

        searchInput.value = '';
        searchResults.innerHTML = '';
    }

    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 2) {
            searchResults.innerHTML = '';
            return;
        }

        fetch(`{% url 'stock_search' %}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                searchResults.innerHTML = '';
                if (data.results && data.results.length > 0) {
                    data.results.forEach(item => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'list-group-item list-group-item-action';
                        btn.innerHTML = `<strong>${item.name}</strong><br><small class="text-muted">${item.info}</small>`;
                        btn.onclick = () => selectItem(item);
                        searchResults.appendChild(btn);
                    });
                } else {
                    searchResults.innerHTML = '<div class="list-group-item text-muted">Ничего не найдено</div>';
                }
            });
    });
});
</script>
{% endblock %}