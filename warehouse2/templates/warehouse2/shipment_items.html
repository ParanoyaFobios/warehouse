{% extends "base.html" %}

{% block content %}

<div class="row">
    <div class="col-md-8">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏ –£–ø–∞–∫–æ–≤–∫–∏ ‚Ññ{{ shipment.id }}</h2>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h5>
            </div>
            <div class="card-body">
                <form method="post" id="shipment-item-form">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">{{ form.product_search.label }}</label>
                        <div class="input-group">
                            {{ form.product_search }}
                            <button type="button" class="btn btn-outline-secondary" id="scan-product-btn">üì∏</button>
                        </div>
                        <div id="search-results" class="mt-2" style="display: none; position: absolute; z-index: 1000; width: 95%;">
                            <div class="list-group" id="search-results-list"></div>
                        </div>
                    </div>

                    <video id="video-stream" style="display: none; width: 100%; max-width: 400px; border-radius: 8px;"></video>
                    
                    {{ form.product }}
                    
                    <div id="selected-product-info" class="card bg-light mb-3" style="display: none;">
                        <div class="card-body">
                            <h6 class="card-title">–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç:</h6>
                            <p id="selected-product-name" class="mb-1"></p>
                            <p id="selected-product-available" class="mb-0 text-muted small"></p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                        {{ form.quantity }}
                    </div>
                    
                    <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                    <a href="{% url 'shipment_detail' shipment.pk %}" class="btn btn-secondary">–ù–∞–∑–∞–¥ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ</a>
                </form>
            </div>
        </div>

        <div class="card">
            </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            </div>
    </div>
</div>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('id_product_search');
    const searchResults = document.getElementById('search-results');
    const resultsList = document.getElementById('search-results-list');
    const productSelect = document.getElementById('id_product'); // –°–∫—Ä—ã—Ç—ã–π <select>
    
    const selectedProductInfo = document.getElementById('selected-product-info');
    const selectedProductName = document.getElementById('selected-product-name');
    const selectedProductAvailable = document.getElementById('selected-product-available');
    
    let searchTimeout;

    // --- –§–£–ù–ö–¶–ò–Ø –í–´–ë–û–†–ê –ü–†–û–î–£–ö–¢–ê (–ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï) ---
    function selectProduct(product) {
        // 1. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π <option>
        const newOption = new Option(product.name, product.id, true, true);
        // 2. –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π. –¢–µ–ø–µ—Ä—å —Ñ–æ—Ä–º–∞ –±—É–¥–µ—Ç –≤–∞–ª–∏–¥–Ω–∞!
        productSelect.innerHTML = '';
        productSelect.appendChild(newOption);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ç–æ–≤–∞—Ä–µ
        selectedProductName.textContent = product.name;
        selectedProductAvailable.textContent = `–î–æ—Å—Ç—É–ø–Ω–æ: ${product.available_quantity} —à—Ç.`;
        selectedProductInfo.style.display = 'block';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫
        searchResults.style.display = 'none';
        searchInput.value = '';
    }

    // --- –ü–û–ò–°–ö –ü–û –¢–ï–ö–°–¢–£ ---
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            searchResults.style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`{% url 'available_product_search' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    resultsList.innerHTML = '';
                    if (data.results && data.results.length > 0) {
                        data.results.forEach(product => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action';
                            item.innerHTML = `<strong>${product.name}</strong> <small class="text-muted">(${product.sku})</small>`;
                            item.addEventListener('click', () => selectProduct(product));
                            resultsList.appendChild(item);
                        });
                    } else {
                        resultsList.innerHTML = `<div class="list-group-item text-muted">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>`;
                    }
                    searchResults.style.display = 'block';
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ:', error));
        }, 300);
    });

    // --- –õ–û–ì–ò–ö–ê –°–ö–ê–ù–ï–†–ê ---
    const codeReader = new ZXingBrowser.BrowserMultiFormatReader();
    const scanButton = document.getElementById('scan-product-btn');
    const videoElement = document.getElementById('video-stream');

    scanButton.addEventListener('click', () => {
        videoElement.style.display = 'block';
        codeReader.decodeFromVideoDevice(undefined, videoElement, (result, err) => {
            if (result) {
                const barcode = result.getText();
                console.log('–ù–∞–π–¥–µ–Ω —à—Ç—Ä–∏—Ö–∫–æ–¥:', barcode);

                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
                codeReader.reset();
                videoElement.style.display = 'none';

                // –ò—â–µ–º —Ç–æ–≤–∞—Ä –ø–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–º—É —à—Ç—Ä–∏—Ö–∫–æ–¥—É
                fetch(`{% url 'available_product_search' %}?q=${encodeURIComponent(barcode)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.results && data.results.length > 0) {
                            // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä
                            selectProduct(data.results[0]);
                        } else {
                            alert('–¢–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
                        }
                    });
            }
            if (err && !(err instanceof ZXingBrowser.NotFoundException)) {
                console.error(err);
            }
        });
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
    document.addEventListener('click', (e) => {
        if (!searchResults.contains(e.target) && !searchInput.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });
});
</script>
{% endblock %}