{% extends "base.html" %}
{% load main_tags %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-7">
            <h2>Отгрузка №{{ shipment.id }}</h2>
            <div class="card mb-4">
                <div class="card-body">
                    <table class="table table-sm">
                        <tr><th>Пункт назначения:</th><td>{{ shipment.destination|default:"Не указан" }}</td></tr>
                        <tr><th>Всего штук:</th><td>{{ shipment.grand_total_quantity }}</td></tr>
                        <tr><th>Всего позиций:</th><td>{{ shipment.items.count }}</td></tr>
                        <tr><th>Общая стоимость:</th><td>{{ shipment.grand_total_price }} грн.</td></tr>
                    </table>
                </div>
            </div>

            <h4>Товары в отгрузке</h4>
            {% if items %}
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Наименование</th>
                        <th>Цена за ед.</th>
                        <th>Кол-во</th>
                        <th>Сумма</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>
                            {% if item.product %}{{ item.product }}{% else %}{{ item.package }}{% endif %}
                        </td>
                        <td>{{ item.price }} грн.</td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ item.position_total_price }} грн.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted">Товары еще не добавлены в отгрузку.</p>
            {% endif %}

            <div class="mt-3">
                {# Если статус "В процессе сборки", показываем кнопки управления #}
                {% if shipment.status == 'pending' %}
                    <a href="{% url 'shipment_items' shipment.pk %}" class="btn btn-primary">Управление товарами</a>
                    
                    <form action="{% url 'shipment_mark_packaged' shipment.pk %}" method="post" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning">Завершить сборку</button>
                    </form>
            
                {# Если статус "Собрано", показываем кнопку "Отгрузить" #}
                {% elif shipment.status == 'packaged' %}
                    <a href="{% url 'shipment_ship' shipment.pk %}" class="btn btn-success">Выполнить отгрузку</a>
                {% endif %}
            
                <a href="{% url 'shipment_list' %}" class="btn btn-secondary">Назад к списку</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}