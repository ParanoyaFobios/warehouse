{% extends "base.html" %}
{% load main_tags %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>–ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–¥—É–∫—Ü–∏–∏</h2>
    <a href="{% url 'product_create' %}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</a>
</div>
<form method="get" class="mb-4" id="filter-form">
    <div class="row">
        <div class="col-md-4">
            <select name="category" class="form-control">
                <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                {% for category in categories %}
                <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>
                    {{ category.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" name="search" class="form-control" 
                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞—Ä—Ç–∏–∫—É–ª—É –∏–ª–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥—É" 
                       value="{{ request.GET.search }}"
                       id="id_search_input">  <button type="button" class="btn btn-outline-secondary" id="scan-btn">üì∏ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
            <a href="?" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
        </div>
    </div>
</form>

<video id="video-stream" style="display: none; width: 100%; max-width: 400px; border-radius: 8px; margin-bottom: 1rem;"></video>

<table class="table table-striped">
    <thead>
        <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–ê—Ä—Ç–∏–∫—É–ª</th>
            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>–†–∞–∑–º–µ—Ä</th>
            <th>–¶–≤–µ—Ç</th>
            <th>–í–µ—Å</th>
            <th>–ù–∞ —Å–∫–ª–∞–¥–µ</th>
            <th>–î–æ—Å—Ç—É–ø–Ω–æ</th>
            <th>–®—Ç—Ä–∏—Ö–∫–æ–¥</th>
            <th>–¶–µ–Ω–∞</th>
        </tr>
    </thead>
    <tbody>
        {% for product in products %}
        <tr>
            <td><a href="{% url 'product_detail' product.pk %}">{{ product.name }}</a></td>
            <td>{{ product.sku }}</td>
            <td>{{ product.category }}</td>
            <td>{{ product.size|default:"-" }}</td>
            <td>{{ product.color|default:"-" }}</td>
            <td>{{ product.weight|default:"-" }}</td>
            <td>{{ product.total_quantity }}</td>
            <td>{{ product.available_quantity }}</td>
            <td><a href="{% url 'generate_barcode' content_type_id=product|get_content_type_id object_id=product.pk %}" alt="–®—Ç—Ä–∏—Ö–∫–æ–¥" class="img-fluid mb-2">{{ product.barcode }}</a></td>
            <td>{{ product.price }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="8" class="text-center">–ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% if is_paginated %}
<nav aria-label="Page navigation">
    <ul class="pagination">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
        </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
        <li class="page-item {% if page_obj.number == num %}active{% endif %}">
            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
        </li>
        {% endfor %}
        
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}">–°–ª–µ–¥—É—é—â–∞—è</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Scanner script for catalog initialized");
        
        const scanButton = document.getElementById('scan-btn');
        const searchInput = document.getElementById('id_search_input');
        const videoElement = document.getElementById('video-stream');
        const filterForm = document.getElementById('filter-form');
        
        if (!scanButton || !searchInput || !videoElement || !filterForm) {
            console.error("Required elements for scanner not found");
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ZXing
        if (typeof ZXing === 'undefined') {
            console.error("ZXing library not loaded");
            scanButton.disabled = true;
            scanButton.title = "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞";
            return;
        }
        
        const codeReader = new ZXing.BrowserMultiFormatReader();
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

        if (isIOS || isSafari) {
            console.log("iOS/Safari detected - applying optimizations");
        }
        let isScanning = false;
        
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        const statusElement = document.createElement('div');
        statusElement.className = 'small text-muted mt-2';
        statusElement.style.display = 'none';
        statusElement.id = 'scanner-status';
        scanButton.parentNode.insertBefore(statusElement, scanButton.nextSibling);
        
        scanButton.addEventListener('click', async function() {
            if (isScanning) {
                // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                stopScanner();
                return;
            }
            
            try {
                // –ù–∞—á–∞–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                console.log("Starting barcode scanner...");
                scanButton.innerHTML = '‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                statusElement.textContent = '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ... –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥';
                statusElement.style.display = 'block';
                videoElement.style.display = 'block';
                isScanning = true;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤
                const hints = new Map();
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                    ZXing.BarcodeFormat.EAN_13,
                    ZXing.BarcodeFormat.CODE_128,
                    ZXing.BarcodeFormat.UPC_A
                ]);

                // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è iOS
                if (isIOS || isSafari) {
                    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                    hints.set(ZXing.DecodeHintType.PURE_BARCODE, true);
                }

                const constraints = {
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                if (isIOS || isSafari) {
                    constraints.video.focusMode = "continuous";
                    constraints.video.advanced = [{ focusMode: "continuous" }];
                }
                // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
                await codeReader.decodeFromVideoDevice(
                    null, 
                    videoElement, 
                    (result, error) => {
                        if (result) {
                            console.log("Scanned barcode:", result.text);
                            searchInput.value = result.text;
                            stopScanner();
                            filterForm.submit();
                        }
                        if (error && !(error instanceof ZXing.NotFoundException)) {
                            console.error("Scan error:", error);
                            statusElement.textContent = '–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message;
                        }
                    },
                    hints,
                    constraints
                );
                
            } catch (error) {
                console.error("Scanner initialization error:", error);
                statusElement.textContent = '–û—à–∏–±–∫–∞: ' + error.message;
                stopScanner();
            }
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞
        function stopScanner() {
            if (isScanning) {
                codeReader.reset();
                videoElement.style.display = 'none';
                scanButton.innerHTML = 'üì∏ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å';
                statusElement.style.display = 'none';
                isScanning = false;
                console.log("Scanner stopped");
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', stopScanner);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ API –∫–∞–º–µ—Ä—ã
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            scanButton.disabled = true;
            scanButton.title = "–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ";
            statusElement.textContent = '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ';
            statusElement.style.display = 'block';
        }
    });
    if (isMobile) {
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    videoElement.style.width = '100%';
    videoElement.style.maxWidth = '100%';
    videoElement.style.objectFit = 'cover';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const hint = document.createElement('div');
    hint.innerHTML = '<p class="text-center small mt-2">–î–µ—Ä–∂–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ 15-30 —Å–º –æ—Ç —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</p>';
    videoElement.parentNode.insertBefore(hint, videoElement.nextSibling);}
</script>
{% endblock %}