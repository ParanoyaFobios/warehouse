{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    {% if is_filtered %}
        <h2>üìÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</h2>
    {% else %}
        <h2>üìã –ó–∞–¥–∞–Ω–∏—è –Ω–∞ —Å–º–µ–Ω—É (–î–æ—Å–∫–∞)</h2>
    {% endif %}
    

</div>

<form method="get" class="row g-3 mb-4 p-3 bg-white border rounded shadow-sm align-items-end">
    <div class="col-md-3">
        <label for="id_due_date" class="form-label">–î–∞—Ç–∞ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏:</label>
        <input type="date" class="form-control" id="id_due_date" name="due_date" value="{{ request.GET.due_date|default:'' }}">
    </div>
    <div class="col-md-3">
        <label for="id_production_order_id" class="form-label">‚Ññ –∑–∞–∫–∞–∑–∞:</label>
        <input type="number" class="form-control" id="id_production_order_id" name="production_order_id" value="{{ request.GET.production_order_id|default:'' }}" min="1">
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div class="col-md-2">
        <a href="{% url 'workorder_list' %}" class="btn btn-secondary w-100">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </div>
</form>

{% regroup workorders by order_item.production_order as grouped_orders %}

<div class="row">
    {% for group in grouped_orders %}
        
        
            <div class="col-12 mb-4">
                <div class="card shadow-sm border-primary">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <h5 class="mb-0 text-primary">
                                <a href="{% url 'workorder_detail' group.grouper.id %}" class="text-decoration-none text-primary">
                                –ó–∞–∫–∞–∑ ‚Ññ{{ group.grouper.id }} 
                                </a>
                                <small class="text-muted ms-2">({{ group.grouper.customer }})</small>
                            </h5>
                            <p class="text-muted">
                                –°—Ä–æ–∫: <strong>{{ group.grouper.due_date|date:"d.m.Y" }}</strong> | 
                                –°—Ç–∞—Ç—É—Å:<h2>{{ group.grouper.get_status_display }}</h2>
                            </p>
                            <h4 class="text-muted ms-2">{{ group.grouper.comment }}</h4>
                        </div>
                        
                        
                        <div class="text-end">
                            <span class="badge bg-white text-dark border">
                                –ü–ª–∞–Ω: {{ group.grouper.total_requested }} —à—Ç.
                            </span>
                            <span class="badge {% if group.grouper.total_produced >= group.grouper.total_requested %}bg-success{% else %}bg-warning text-dark{% endif %}">
                                –§–∞–∫—Ç: {{ group.grouper.total_produced }} —à—Ç.
                            </span>
                        </div>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div id="progress-{{ group.grouper.id }}" class="progress-bar bg-success" role="progressbar" 
                             style="width: {% widthratio group.grouper.total_produced group.grouper.total_requested 100 %}%">
                        </div>
                    </div>
                    <small class="text-muted" id="remaining-text-{{ group.grouper.id }}">
                    
                </div>
            </div>
            
    {% endfor %}
    
    {% if not workorders %}
         <div class="col-12 text-center py-5">
            <h4 class="text-muted">–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è üéâ</h4>
         </div>
    {% endif %}
</div>
{% endblock %}