{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    {% if is_filtered %}
        <h2>üìÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</h2>
    {% else %}
        <h2>üìã –ó–∞–¥–∞–Ω–∏—è –Ω–∞ —Å–º–µ–Ω—É (–î–æ—Å–∫–∞)</h2>
    {% endif %}
    

</div>

<form method="get" class="row g-3 mb-4 p-3 bg-white border rounded shadow-sm align-items-end">
    <div class="col-md-3">
        <label for="id_due_date" class="form-label">–î–∞—Ç–∞ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏:</label>
        <input type="date" class="form-control" id="id_due_date" name="due_date" value="{{ request.GET.due_date|default:'' }}">
    </div>
    <div class="col-md-3">
        <label for="id_production_order_id" class="form-label">‚Ññ –∑–∞–∫–∞–∑–∞:</label>
        <input type="number" class="form-control" id="id_production_order_id" name="production_order_id" value="{{ request.GET.production_order_id|default:'' }}" min="1">
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div class="col-md-2">
        <a href="{% url 'workorder_list' %}" class="btn btn-secondary w-100">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </div>
</form>

{% regroup workorders by order_item.production_order as grouped_orders %}

<div class="row">
    {% for group in grouped_orders %}
        
        {% if group.grouper %}
            <div class="col-12 mb-4">
                <div class="card shadow-sm border-primary">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <h5 class="mb-0 text-primary">
                                –ó–∞–∫–∞–∑ ‚Ññ{{ group.grouper.id }} 
                                <small class="text-muted ms-2">({{ group.grouper.customer }})</small>
                            </h5>
                            <small class="text-muted">
                                –°—Ä–æ–∫: <strong>{{ group.grouper.due_date|date:"d.m.Y" }}</strong> | 
                                –°—Ç–∞—Ç—É—Å: {{ group.grouper.get_status_display }}
                            </small>
                        </div>
                        
                        <div class="text-end">
                            <span class="badge bg-white text-dark border">
                                –ü–ª–∞–Ω: {{ group.grouper.total_requested }} —à—Ç.
                            </span>
                            <span class="badge {% if group.grouper.total_produced >= group.grouper.total_requested %}bg-success{% else %}bg-warning text-dark{% endif %}">
                                –§–∞–∫—Ç: {{ group.grouper.total_produced }} —à—Ç.
                            </span>
                        </div>
                    </div>

                    <ul class="list-group list-group-flush">
                        {% for wo in group.list %}
                            <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap {% if wo.status == 'completed' %}bg-light{% endif %}">
                                
                                <div class="ms-2 me-auto py-2">
                                    <div class="fw-bold">
                                        <a href="{% url 'product_detail' wo.product.pk %}" class="text-decoration-none text-dark">
                                            {{ wo.product.name }}
                                        </a>
                                        {% if wo.status == 'completed' %}
                                            <span class="badge bg-success ms-2">–ì–æ—Ç–æ–≤</span>
                                        {% elif wo.status == 'in_progress' %}
                                            <span class="badge bg-warning text-dark ms-2">–í —Ä–∞–±–æ—Ç–µ</span>
                                        {% else %}
                                            <span class="badge bg-secondary ms-2">–ù–æ–≤—ã–π</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">{{ wo.product.sku }}</small>
                                    {% if wo.comment %}<br><small class="text-info">Com: {{ wo.comment }}</small>{% endif %}
                                </div>

                                <div class="text-end d-flex align-items-center gap-3">
                                    
                                    <div style="min-width: 120px; text-align: right;">
                                        <span class="d-block fw-bold {% if wo.is_completed %}text-success{% endif %}">
                                            {{ wo.quantity_produced }} / {{ wo.quantity_planned }}
                                        </span>
                                        <small class="text-muted">–û—Å—Ç–∞–ª–æ—Å—å: {{ wo.remaining_to_produce }}</small>
                                    </div>

                                    {% if wo.status != 'completed' %}
                                        <a href="{% url 'workorder_report' wo.pk %}?{{ request.GET.urlencode }}" class="btn btn-success btn-sm">
                                            –û—Ç—á–∏—Ç–∞—Ç—å—Å—è
                                        </a>
                                    {% else %}
                                        <button class="btn btn-outline-secondary btn-sm" disabled>‚úî</button>
                                    {% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

        {% else %}
            {% if group.list %}
            <div class="col-12 mb-3">
                <h4 class="text-secondary border-bottom pb-2">‚ö° –°—Ä–æ—á–Ω—ã–µ –∑–∞–¥–∞—á–∏ (Ad-Hoc)</h4>
            </div>
            
            {% for wo in group.list %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 shadow-sm border-start border-4 border-info">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge bg-info text-dark">Ad-Hoc</span>
                                <small class="text-muted">#{{ wo.id }}</small>
                            </div>
                            <h5 class="card-title">{{ wo.product.name }}</h5>
                            <p class="card-text text-muted small">{{ wo.comment|default:"–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è" }}</p>
                            
                            <div class="progress mb-2" style="height: 15px;">
                                {% widthratio wo.quantity_produced wo.quantity_planned 100 as percent %}
                                <div class="progress-bar bg-info" style="width: {{ percent }}%;">
                                    {{ wo.quantity_produced }}/{{ wo.quantity_planned }}
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <small>–û—Å—Ç–∞—Ç–æ–∫: <b>{{ wo.remaining_to_produce }}</b></small>
                                {% if wo.status != 'completed' %}
                                    <a href="{% url 'workorder_report' wo.pk %}?{{ request.GET.urlencode }}" class="btn btn-success btn-sm">–û—Ç—á–∏—Ç–∞—Ç—å—Å—è</a>
                                {% else %}
                                    <span class="text-success fw-bold">–ì–æ—Ç–æ–≤–æ</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-top-0 text-end">
                             <a href="{% url 'workorder_edit' wo.pk %}" class="text-secondary small">–†–µ–¥.</a>
                             <a href="{% url 'workorder_delete' wo.pk %}" class="text-danger small ms-2">–£–¥–∞–ª.</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
            <div class="col-12"><hr class="my-4"></div>
            {% endif %}

        {% endif %}
        
    {% endfor %}
    
    {% if not workorders %}
         <div class="col-12 text-center py-5">
            <h4 class="text-muted">–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è üéâ</h4>
         </div>
    {% endif %}
</div>
{% endblock %}