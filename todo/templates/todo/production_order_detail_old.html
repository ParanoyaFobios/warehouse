{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0">Заказ №{{ order.pk }}</h2>
                <p class="text-muted mb-0">{{ order.customer }} | Срок: {{ order.due_date|date:"d.m.Y" }}</p>
            </div>
            <a href="{% url 'workorder_list' %}" class="btn btn-outline-secondary">← Назад к списку</a>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">Производственные задания</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th>Продукт</th>
                        <th class="text-center" style="width: 150px;">Статус</th>
                        <th class="text-center" style="width: 200px;">Прогресс</th>
                        <th class="text-end" style="width: 300px;">Отчет о выпуске</th>
                    </tr>
                </thead>
                <tbody>
                    {% for wo in workorders %}
                    <tr id="row-{{ wo.pk }}" class="{% if wo.status == 'completed' %}table-success{% endif %}">
                        
                        <td>
                            <div class="fw-bold">{{ wo.product.name }}</div>
                            <small class="text-muted">{{ wo.product.sku }}</small>
                            <div class="small text-secondary mt-1">{{ wo.note|default:"" }}</div>
                        </td>

                        <td class="text-center">
                            <span class="badge bg-{{ wo.status_badge_class }}" id="badge-{{ wo.pk }}">
                                {{ wo.get_status_display }}
                            </span>
                        </td>

                        <td class="text-center">
                            <div class="fw-bold mb-1">
                                <span id="produced-{{ wo.pk }}">{{ wo.quantity_produced }}</span> / {{ wo.quantity_planned }}
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div id="progress-{{ wo.pk }}" class="progress-bar bg-success" role="progressbar" 
                                     style="width: {% widthratio wo.quantity_produced wo.quantity_planned 100 %}%">
                                </div>
                            </div>
                            <small class="text-muted" id="remaining-text-{{ wo.pk }}">
                                Осталось: {{ wo.remaining_to_produce }}
                            </small>
                        </td>

                        <td>
                            {% if wo.status != 'completed' %}
                            <div class="input-group input-group-sm justify-content-end" id="control-panel-{{ wo.pk }}">
                                <input type="number" 
                                       class="form-control" 
                                       id="input-{{ wo.pk }}" 
                                       placeholder="Кол-во" 
                                       min="1" 
                                       max="{{ wo.remaining_to_produce }}"
                                       style="max_width: 80px;">
                                <button class="btn btn-primary btn-report" 
                                        data-id="{{ wo.pk }}" 
                                        type="button">
                                    <i class="bi bi-check-lg"></i> ОК
                                </button>
                            </div>
                            {% else %}
                            <div class="text-end text-success fw-bold">
                                <i class="bi bi-check-circle-fill"></i> Готово
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const buttons = document.querySelectorAll('.btn-report');

    buttons.forEach(button => {
        button.addEventListener('click', function() {
            const woId = this.getAttribute('data-id');
            const inputField = document.getElementById(`input-${woId}`);
            const quantity = inputField.value;

            if (!quantity || quantity <= 0) {
                alert("Введите количество!");
                return;
            }

            // Блокируем кнопку, чтобы не нажали дважды
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            fetch("{% url 'api_workorder_report' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'workorder_id': woId,
                    'quantity': quantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 1. Обновляем цифры
                    document.getElementById(`produced-${woId}`).innerText = data.new_produced;
                    document.getElementById(`remaining-text-${woId}`).innerText = `Осталось: ${data.remaining}`;
                    
                    // 2. Обновляем прогресс-бар
                    const percent = (data.new_produced / data.total_qty) * 100;
                    const progressBar = document.getElementById(`progress-${woId}`);
                    progressBar.style.width = percent + "%";

                    // 3. Обновляем статус
                    const badge = document.getElementById(`badge-${woId}`);
                    badge.className = `badge bg-${data.status_class}`;
                    badge.innerText = data.status_label;

                    // 4. Очищаем инпут
                    inputField.value = '';
                    
                    // 5. Если заказ завершен, скрываем форму и красим строку
                    if (data.is_completed) {
                        document.getElementById(`control-panel-${woId}`).innerHTML = 
                            '<div class="text-end text-success fw-bold"><i class="bi bi-check-circle-fill"></i> Готово</div>';
                        document.getElementById(`row-${woId}`).classList.add('table-success');
                    }

                    // Опционально: показать тост/уведомление успеха
                } else {
                    alert('Ошибка: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка соединения');
            })
            .finally(() => {
                // Разблокируем кнопку (если она еще существует)
                if (document.body.contains(this)) {
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-check-lg"></i> ОК';
                }
            });
        });
    });
});
</script>
{% endblock %}