{% extends 'base.html' %}
{% block content %}
    <main class="main">
      <section class="section creating-order container">
        <div class="section__header">
            <h1 class="section__header-title flex-center">
                {% if form.instance.pk %}Редактирование заказа №{{ form.instance.pk }}{% else %}Создание заказа{% endif %}
            </h1>
        </div>
        <form method="post" id="main-order-form" class="narrow-wrapper">
            {% csrf_token %}
            <input type="hidden" name="items_data" id="id_items_data">
            <input type="hidden" id="initial-items-data" value="{{ existing_items_json }}">
          <div class="section__other-buttons-cont">
            <a
              class="section__other-buttons-cont-button section__other-buttons-cont-button--orange"
              href="{% url 'portfolio_list' %}"
            >
              <span class="content-size">
                <svg
                  width="30"
                  height="30"
                  viewBox="0 0 30 30"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <rect width="30" height="30" rx="3" fill="#F28500" />
                  <path
                    d="M15.944 24C15.8073 24 15.6706 23.9554 15.5612 23.862L5.24216 15.511C5.08983 15.3892 5 15.1985 5 14.9997C5 14.8008 5.08983 14.6101 5.24216 14.4884L15.5612 6.13733C15.7487 5.98313 16.0065 5.95879 16.2213 6.06429C16.4361 6.17385 16.5728 6.40109 16.5728 6.64862V12.2972H20.5137C21.7245 12.2972 22.7986 12.7273 23.611 13.5389C24.3336 14.2612 24.814 15.2594 24.9546 16.3428C25.0991 17.4303 24.896 18.53 24.3843 19.4349C23.8102 20.4494 22.8923 21.1636 21.7284 21.5004C21.5019 21.5653 21.2597 21.4922 21.0996 21.3137C20.9395 21.1352 20.8926 20.8755 20.9746 20.6442C21.2519 19.8813 21.5058 18.8628 21.1543 18.3312C20.877 17.9132 20.1817 17.7022 19.0842 17.7022H16.5689V23.3467C16.5689 23.5942 16.4322 23.8215 16.2174 23.931C16.1314 23.9797 16.0377 24 15.944 24Z"
                    fill="white"
                  />
                </svg>
              </span>
              <span>Назад к планированию</span>
            </a>
          </div>
          <div class="form-wrapper form-wrapper--m-t-20">
            <div class="form-cont__form">
              <div
                class="form-cont__form-paragraphs-cont form-cont__form-paragraphs-cont--alt"
              >
                <div class="cont__header">
                  <h2 class="cont__title">Основные данные</h2>
                </div>
                <div
                  class="form-cont__form-paragraphs-cont form-cont__form-paragraphs-cont--with-alt-pad-top"
                >
                <div class="form-cont__form-paragraph">
                    <label for="id_customer">Заказчик</label>
                    <input type="text" id="id_customer" name="customer" class="form-input" 
                           value="{{ form.customer.value|default:'' }}" />
                    <div class="text-danger small">{{ form.customer.errors }}</div>
                </div>
                <div class="form-cont__form-paragraph">
                  <label for="{{ form.due_date.id_for_label }}">Дата отгрузки</label>
                  {{ form.due_date }} 
                  {% if form.due_date.errors %}
                      <div class="text-danger small">{{ form.due_date.errors }}</div>
                  {% endif %}
              </div>
                </div>
              </div>
              <div class="form-cont__form-paragraph form-cont__form-paragraph--without-pad-top">
                <label for="id_comment">Комментарий</label>
                <textarea placeholder="Текст..." class="form-textarea" id="id_comment" name="comment">{{ form.comment.value|default:'' }}</textarea>
            </div>
            </div>
          </div>
          <div class="form-wrapper form-wrapper--m-t-20">
            <div class="form-cont__form">
              <div
                class="form-cont__form-paragraphs-cont form-cont__form-paragraphs-cont--alt"
              >
                <div class="cont__header">
                  <h2 class="cont__title">Товары</h2>
                </div>
                <div class="form-cont__form-paragraph">
                  <label for="product-search-input">Добавление товара</label>
                  <input
                    type="text"
                    id="product-search-input"
                    
                    class="form-input"
                    placeholder="Название/ артикул / штрихкод"
                    autocomplete="off"
                  />
                  <div id="search-results-dropdown" class="list-group position-absolute w-100 shadow" style="z-index: 1000; display: none;"></div>
                </div>

                <div
                  class="tables-cont tables-cont--second-type tables-cont--m-t-10-20"
                >
                  <div class="cont__header">
                    <h2 class="cont__title">Товары в заказе</h2>
                  </div>

                    <ul class="cont__list cont__list--narrow cont__list--narrow-double" id="selected-items-list">
                        <li id="empty-row-msg" class="progress__text">Список пуст. Найдите и добавьте товары.</li>
                    </ul>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <button type="submit" class="button button--orange width100 m-top20">
            Сохранить
          </button>
        </form>
      </section>
    </main>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    
    // ПЕРЕМЕННЫЕ
    const searchInput = document.getElementById('product-search-input');
    const resultsDropdown = document.getElementById('search-results-dropdown');
    const itemsList = document.getElementById('selected-items-list'); // Изменено на список
    const emptyMsg = document.getElementById('empty-row-msg');
    const mainForm = document.getElementById('main-order-form');
    const hiddenInput = document.getElementById('id_items_data');
    const initialDataField = document.getElementById('initial-items-data');
    
    const SEARCH_URL = "{% url 'product_search_json' %}";
    let searchTimeout;

    // ------------------------------------------------
    // --- 1. ДОБАВЛЕНИЕ КАРТОЧКИ (ОБНОВЛЕННАЯ ФУНКЦИЯ) ---
    // ------------------------------------------------
    function addProductToList(product, isExisting = false) {
    if (emptyMsg) emptyMsg.style.display = 'none';

    // Проверяем, есть ли уже такой ТОВАР (по product.id)
    const existingRow = itemsList.querySelector(`li[data-id="${product.id}"]`);
    if (existingRow && !isExisting) {
        alert("Этот товар уже есть в списке.");
        return;
    }

    const li = document.createElement('li');
    li.className = 'cont__item';
    li.setAttribute('data-id', product.id);
    
    // Если это строка из базы, сохраняем её PK (первичный ключ ProductionOrderItem)
    if (isExisting && product.pk) {
        li.setAttribute('data-pk', product.pk); 
    }

    const initialQty = product.qty || 1;
    const stockQty = product.available_quantity || 0;

    li.innerHTML = `
        <article class="table-card-first">
            <table class="table-first">
                <tr class="table__row"><th>Товар</th><td>${product.name}</td></tr>
                <tr class="table__row"><th>Артикул</th><td>${product.sku}</td></tr>
                <tr class="table__row"><th>На складе</th><td>${stockQty} шт</td></tr>
                <tr class="table__row">
                    <td class="table__td-buttons-cont">
                        <button class="table__button-with-icon remove-btn" type="button">
                            <svg width="20" height="20" viewBox="0 0 30 30" fill="none">
                                <rect width="30" height="30" rx="3" fill="#F28500" fill-opacity="0.6"/>
                                <path d="M23.145 10.25L22.363 23.166C22.275 24.618 21.072 25.75 19.618 25.75H10.382C8.92798 25.75 7.72498 24.618 7.63698 23.166L6.85498 10.25H23.145ZM12.246 20.91L11.549 13.941C11.508 13.529 11.14 13.228 10.728 13.269C10.316 13.31 10.015 13.678 10.056 14.09L10.754 21.059C10.795 21.471 11.163 21.772 11.575 21.731C11.987 21.69 12.287 21.322 12.246 20.91ZM19.246 21.059L19.944 14.09C19.985 13.678 19.684 13.31 19.272 13.269C18.86 13.228 18.492 13.529 18.451 13.941L17.754 20.91C17.713 21.322 18.013 21.69 18.425 21.731C18.837 21.772 19.205 21.471 19.246 21.059ZM14.25 14V21C14.25 21.414 14.586 21.75 15 21.75C15.414 21.75 15.75 21.414 15.75 21V14C15.75 13.586 15.414 13.25 15 13.25C14.586 13.25 14.25 13.586 14.25 14Z"
                                    fill="white">
                            </svg>
                        </button>
                    </td>
                </tr>
            </table>
            <div class="form-cont__form-paragraph">
                <label>Количество</label>
                <input type="number" class="form-input item-qty" value="${initialQty}" min="1">
            </div>
        </article>
    `;

    li.querySelector('.remove-btn').addEventListener('click', () => {
        li.remove();
        if (itemsList.querySelectorAll('li[data-id]').length === 0) {
            emptyMsg.style.display = 'block';
        }
    });

    itemsList.appendChild(li);
}

    // --- 2. ЛОГИКА ПОИСКА (БЕЗ ИЗМЕНЕНИЙ, ТОЛЬКО ВЫЗОВ НОВОЙ ФУНКЦИИ) ---
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        clearTimeout(searchTimeout);
        if (query.length < 2) {
            resultsDropdown.style.display = 'none';
            return;
        }
        searchTimeout = setTimeout(() => {
            fetch(`${SEARCH_URL}?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => renderSearchResults(data.results))
                .catch(err => console.error(err));
        }, 300);
    });

    function renderSearchResults(results) {
        resultsDropdown.innerHTML = '';
        if (results.length === 0) {
            resultsDropdown.innerHTML = '<div class="list-group-item text-muted">Ничего не найдено</div>';
            resultsDropdown.style.display = 'block';
            return;
        }
        results.forEach(prod => {
            const item = document.createElement('a');
            item.href = "#";
            item.className = "list-group-item list-group-item-action";
            const stockQty = prod.available_quantity !== undefined ? prod.available_quantity : 0;
            item.innerHTML = `
                <div class="d-flex justify-content-between">
                    <span><strong>${prod.name}</strong> <small class="text-muted">(${prod.sku})</small></span>
                    <span class="badge bg-light text-dark">Склад: ${stockQty}</span>
                </div>
            `;
            item.addEventListener('click', function(e) {
                e.preventDefault();
                addProductToList(prod, false); 
                searchInput.value = '';
                resultsDropdown.style.display = 'none';
            });
            resultsDropdown.appendChild(item);
        });
        resultsDropdown.style.display = 'block';
    }

    // Закрытие дропдауна при клике мимо
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsDropdown.contains(e.target)) {
            resultsDropdown.style.display = 'none';
        }
    });

    // --- 3. ИНИЦИАЛИЗАЦИЯ (UPDATE VIEW) ---
    if (initialDataField && initialDataField.value.trim().length > 0) {
        try {
            const initialItems = JSON.parse(initialDataField.value);
            if (initialItems.length > 0) {
                if (emptyMsg) emptyMsg.style.display = 'none'; 
                initialItems.forEach(item => addProductToList(item, true));
            }
        } catch (e) { console.error("Ошибка парсинга:", e); }
    }

    // --- 4. СБОР ДАННЫХ ПЕРЕД ОТПРАВКОЙ ---
    mainForm.addEventListener('submit', function(e) {
        const items = [];
        const cardElements = itemsList.querySelectorAll('li[data-id]');
        
        cardElements.forEach(el => {
            const id = el.getAttribute('data-id');
            const pk = el.getAttribute('data-pk') || null;
            const qtyInput = el.querySelector('.item-qty');
            
            if(id && qtyInput.value > 0) {
                items.push({
                    id: parseInt(id),
                    pk: pk ? parseInt(pk) : null,
                    qty: parseInt(qtyInput.value)
                });
            }
        });

        if (items.length === 0) {
            e.preventDefault();
            alert("Пожалуйста, добавьте хотя бы один товар.");
            return;
        }
        hiddenInput.value = JSON.stringify(items);
    });
});
</script>
    {% endblock %}