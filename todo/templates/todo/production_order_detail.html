{% extends "base.html" %}
{% block content %}
<main class="main">
    <section class="section order-details container">
        <div class="section__header">
            <h1 class="section__header-title section__header-title--double flex-center">
                <span class="section__header-title-not-dedicated-block">
                    Заказ №{{ order.pk }} ({{ order.customer }})
                </span>
                <span class="section__header-title-dedicated-block">
                    Срок - {{ order.due_date|date:"d.m.Y" }}
                </span>
            </h1>
            <a href="{% url 'workorder_list' %}" class="section__header-button button button--orange">
                Назад к списку
            </a>
        </div>

        <div class="tables-cont tables-cont--first-type tables-cont--without-m-t">
            <ul class="cont__list">
                {% for wo in workorders %}
                <li class="cont__item" id="row-{{ wo.pk }}">
                    <article class="table-card-first">
                        <a href="{% url 'product_detail' wo.product.pk %}">
                            <h1 class="table-card-first__title">Позиция №{{ wo.pk }}</h1>
                        </a>
                        <table class="table-first">
                            <tr class="table__row">
                                <th>Товар</th>
                                <td class="table__row--color table__row--color-alt">
                                    {{ wo.product.name }}
                                </td>
                            </tr>
                            <tr class="table__row">
                                <th>Артикул</th>
                                <td>{{ wo.product.sku }}</td>
                            </tr>
                            <tr class="table__row">
                                <th>Статус</th>
                                <td id="badge-{{ wo.pk }}" class="table__status table__status--{{ wo.status_badge_class }}">
                                    {{ wo.get_status_display }}
                                </td>
                            </tr>
                            <tr class="table__row">
                                <th>План</th>
                                <td>{{ wo.quantity_planned }} шт</td>
                            </tr>
                        </table>

                        <div class="table-card-first__bottom-cont">
                            <div class="progress">
                                <div class="progress__info progress__info--double">
                                    <div class="progress__info-block">
                                        <span class="progress__text">Готово</span>
                                        <span class="progress__quantity"><span id="produced-{{ wo.pk }}">{{ wo.quantity_produced }}</span> шт</span>
                                    </div>
                                    <div class="progress__info-block">
                                        <span class="progress__text">Остаток</span>
                                        <span class="progress__quantity" id="remaining-text-{{ wo.pk }}">{{ wo.remaining_to_produce }} шт</span>
                                    </div>
                                    
                                    <div id="done-icon-{{ wo.pk }}" class="progress__info-completed flex-center" style="{% if wo.status != 'completed' %}display:none;{% endif %}">
                                        <svg width="80" height="81" viewBox="0 0 80 81" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M73.5101 7.78711C72.324 7.7941 71.1887 8.27631 70.3528 9.12844C70.3528 9.12844 51.574 28.1049 40.1701 39.6437L32.1332 31.5063C30.382 29.7377 27.5475 29.7377 25.7963 31.5063C24.0497 33.2793 24.0497 36.1492 25.7963 37.9223L37.0127 49.2789C38.764 51.0472 41.5983 51.0472 43.3495 49.2789C53.96 38.5397 76.6896 15.5445 76.6896 15.5445C78.4363 13.7714 78.4363 10.9015 76.6896 9.12844C75.8482 8.2709 74.704 7.78816 73.5101 7.78711Z" fill="#F28500"/>
                                            <path d="M37.8983 4.16211C18.1286 4.16228 2 20.4746 2 40.4915C2 60.5081 18.1286 76.8384 37.8983 76.8384C54.1217 76.8384 68.3651 65.7686 72.5639 49.902C73.3759 46.8345 73.7789 43.6672 73.779 40.4915C73.779 37.9849 71.7739 35.9521 69.2983 35.9488C66.8227 35.9521 64.8176 37.9849 64.8176 40.4915C64.8174 42.8734 64.4977 45.2531 63.8887 47.5538C60.7298 59.4907 50.1038 67.7649 37.8983 67.765C22.9781 67.7649 10.9614 55.5982 10.9614 40.4915C10.9614 25.3848 22.978 13.2356 37.8983 13.2356C40.2511 13.2358 42.5834 13.5603 44.8559 14.176C47.2492 14.8257 49.7096 13.3881 50.3514 10.9648C50.352 10.9627 50.3525 10.9604 50.3531 10.9583C50.9948 8.53505 49.5748 6.04399 47.1815 5.39428C47.1794 5.39376 47.1773 5.39306 47.1751 5.39253C44.1451 4.57062 41.0353 4.16228 37.8983 4.16211Z" fill="#F28500"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="progress__bar">
                                    <div
                                        id="progress-{{ wo.pk }}"
                                        style="width: {% widthratio wo.quantity_produced wo.quantity_planned 100 %}%"
                                        class="progress__bar-inner"
                                        role="progressbar"
                                    ></div>
                                </div>
                            </div>

                            <div id="action-area-{{ wo.pk }}">
                                {% if wo.status != 'completed' %}
                                <div class="table-card-first__form-input-cont">
                                    <label>Произведено</label>
                                    <input
                                        type="number"
                                        id="input-{{ wo.pk }}"
                                        placeholder="Кол-во"
                                        min="1"
                                        max="{{ wo.remaining_to_produce }}"
                                        class="form-control"
                                    />
                                </div>
                                <button class="button button--blue btn-report" type="button" data-id="{{ wo.pk }}">
                                    <i class="bi bi-check-lg"></i>
                                    Отчитаться
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                </li>
                {% endfor %}
            </ul>
            
            {% if is_paginated %}
<div class="pagination">
  <div class="pagination__block">
    {% if page_obj.has_previous %}
      <a class="pagination__button" href="?page=1">
        <span class="content-size">«</span> </a>
      <a class="pagination__button" href="?page={{ page_obj.previous_page_number }}">
        <span class="content-size">‹</span>
      </a>
    {% endif %}
  </div>

  <div class="pagination__block">
    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
        <button class="pagination__button pagination__button--active" type="button">
          <span class="content-size">{{ num }}</span>
        </button>
      {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <a href="?page={{ num }}" class="pagination__button">
          <span class="content-size">{{ num }}</span>
        </a>
      {% endif %}
    {% endfor %}
  </div>

  <div class="pagination__block">
    {% if page_obj.has_next %}
      <a class="pagination__button" href="?page={{ page_obj.next_page_number }}">
        <span class="content-size">›</span>
      </a>
      <a class="pagination__button" href="?page={{ page_obj.paginator.num_pages }}">
        <span class="content-size">»</span>
      </a>
    {% endif %}
  </div>
</div>
{% endif %}
        </div>
    </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ищем кнопки по добавленному классу .btn-report
    const buttons = document.querySelectorAll('.btn-report');

    buttons.forEach(button => {
        button.addEventListener('click', function() {
            const woId = this.getAttribute('data-id');
            const inputField = document.getElementById(`input-${woId}`);
            const quantity = inputField.value;

            if (!quantity || quantity <= 0) {
                alert("Введите количество!");
                return;
            }

            this.disabled = true;
            const originalText = this.innerHTML;
            this.innerHTML = '...';

            fetch("{% url 'api_workorder_report' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'workorder_id': woId,
                    'quantity': quantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 1. Цифры
                    document.getElementById(`produced-${woId}`).innerText = data.new_produced;
                    document.getElementById(`remaining-text-${woId}`).innerText = `${data.remaining} шт`;
                    
                    // 2. Прогресс
                    const percent = (data.new_produced / data.total_qty) * 100;
                    document.getElementById(`progress-${woId}`).style.width = percent + "%";

                    // 3. Статус (меняем текст и класс)
                    const badge = document.getElementById(`badge-${woId}`);
                    badge.className = `table__status table__status--${data.status_class}`;
                    badge.innerText = data.status_label;

                    // 4. Очистка
                    inputField.value = '';
                    
                    // 5. Если финиш
                    if (data.is_completed) {
                        // Скрываем форму ввода и кнопку
                        document.getElementById(`action-area-${woId}`).innerHTML = '';
                        // Показываем оранжевую галку (SVG)
                        document.getElementById(`done-icon-${woId}`).style.display = 'flex';
                    }
                } else {
                    alert('Ошибка: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ошибка соединения');
            })
            .finally(() => {
                if (document.body.contains(this)) {
                    this.disabled = false;
                    this.innerHTML = originalText;
                }
            });
        });
    });
});
</script>
{% endblock %}