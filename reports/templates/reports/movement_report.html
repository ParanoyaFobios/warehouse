{% extends "base.html" %}
{% block content %}
{% load custom_filters %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>–û—Ç—á–µ—Ç –æ –¥–≤–∏–∂–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤</h2>
        <a href="{% url 'reports_home' %}" class="btn btn-secondary">–í—Å–µ –æ—Ç—á–µ—Ç—ã</a>
    </div>
    
    <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3">{{ filter_form.start_date.label_tag }} {{ filter_form.start_date }}</div>
                <div class="col-md-3">{{ filter_form.end_date.label_tag }} {{ filter_form.end_date }}</div>
                <div class="col-md-3">{{ filter_form.operation_type.label_tag }} {{ filter_form.operation_type }}</div>
                <div class="col-md-3">{{ filter_form.item_search.label_tag }} {{ filter_form.item_search }}</div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    <a href="{% url 'movement_report' %}" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–≥—Ä—É–∑–∫–∏ –≤ Excel -->
                    <button type="submit" name="export_excel" value="1" class="btn btn-success">
                        üìä –í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <span class="text-muted">
                –ü–æ–∫–∞–∑–∞–Ω–æ {{ page_obj.start_index }} - {{ page_obj.end_index }} –∏–∑ {{ page_obj.paginator.count }} –∑–∞–ø–∏—Å–µ–π
            </span>
        </div>
        
        <!-- –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ -->
        <div class="d-flex align-items-center">
            <span class="me-2 text-muted">–ó–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</span>
            <select id="perPageSelect" class="form-select form-select-sm" style="width: auto;">
                {% for option in per_page_options %}
                <option value="{{ option }}" {% if option == per_page %}selected{% endif %}>
                    {{ option }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
    <div class="table-responsive">
        <table class="table table-striped table-hover table-sm">
            <thead class="table-light">
                <tr>
                    <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                    <th>–°–∫–ª–∞–¥</th>
                    <th>–¢–æ–≤–∞—Ä/–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                    <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                    <th>–û–ø–µ—Ä–∞—Ü–∏—è</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>–û—Å–Ω–æ–≤–∞–Ω–∏–µ/–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                </tr>
            </thead>
            <tbody>
                {% for op in page_obj %}
                <tr>
                    <td>{{ op.timestamp|date:"d.m.Y H:i" }}</td>
                    <td>{{ op.warehouse }}</td>
                    <td>{{ op.item_name }}</td>
                    <td>{{ op.item_sku }}</td>
                    <td>{{ op.operation }}</td>
                    <td><strong>{{ op.quantity }}</strong></td>
                    <td>{{ op.user }}</td>
                    <td>{{ op.source }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if page_obj.has_other_pages %}
    <nav>
        <ul class="pagination">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&{{ request.GET.urlencode|remove_param:'page' }}">&laquo;</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode|remove_param:'page' }}">‚Äπ</a>
                </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}&{{ request.GET.urlencode|remove_param:'page' }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode|remove_param:'page' }}">‚Ä∫</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&{{ request.GET.urlencode|remove_param:'page' }}">&raquo;</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    document.getElementById('perPageSelect').addEventListener('change', function() {
        const perPage = this.value;
        const url = new URL(window.location.href);
        url.searchParams.set('per_page', perPage);
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        url.searchParams.delete('page');
        window.location.href = url.toString();
    });
});
</script>
{% endblock %}